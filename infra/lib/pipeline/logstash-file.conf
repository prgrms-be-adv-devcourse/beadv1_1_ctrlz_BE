# 파일 읽기
input {
    tcp {
        port => 5044
        codec => "json"
    }
    file {
        path => "/usr/share/logstash/logs/*.log"
        # 파일의 끝 부터 읽음
        start_position => "end"
        # # 파일 변경사항 추적: 운영 환경에서 데이터 중복 방지
        # sincedb_path => "/dev/null" 주석 처리 시 기본값
        # json 형식의 데이터를 읽음
        codec => "json"
    }
}

# 파일명 추출 및 TCP 입력 처리
filter {
  if [path] {
    # File input: path에서 filename 추출
    grok {
      match => { "path" => ".*/%{GREEDYDATA:filename}\.log" }
    }
  } else {
    # TCP input: logger_name과 level로 filename 결정
    if [logger_name] =~ /^API/ {
      mutate { add_field => { "filename" => "api-log" } }
    } else if [logger_name] =~ /^com\./ {
      # Business logic logs
      if [level] == "ERROR" {
        mutate { add_field => { "filename" => "application-error-log" } }
      } else if [level] == "WARN" {
        mutate { add_field => { "filename" => "application-warn-log" } }
      } else {
        mutate { add_field => { "filename" => "application-info-log" } }
      }
    } else {
      # System/Root logs
      mutate { add_field => { "filename" => "system-log" } }
    }
  }
}

# elasticsearch
output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{filename}-%{+YYYY.MM.dd}"
  }
}
