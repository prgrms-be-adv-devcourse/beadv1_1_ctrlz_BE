<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/success-page.css}" />
    <title>충전 완료</title>
</head>
<body>
<div class="success-container">

    <div class="loading" id="loading">
        결제 정보를 확인 중입니다...
    </div>

    <div id="success-content" style="display: none;">
        <div class="success-icon">✓</div>

        <h1 class="success-title">충전이 완료되었습니다.</h1>
        <p class="success-subtitle">충전이 정상적으로 처리되었습니다.</p>

        <div class="order-info">

            <h3>충전 정보</h3>

            <div class="info-row">
                <span class="info-label">충전번호</span>
                <span class="info-value" id="orderId"></span>
            </div>


            <div class="info-row">
                <span class="info-label">충전금액</span>
                <span class="info-value" id="amount"></span>
            </div>

        </div>

        <div class="action-buttons">
            <a href="/" class="btn btn-primary">확인</a>
        </div>

    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);

        const orderId = urlParams.get("orderId") || "";
        const amount = parseInt(urlParams.get("amount")) || 0;

        let displayOrderId = orderId;

        if (orderId) {
            // orderId 문자열을 '-' 기준으로 분할
            const parts = orderId.split('-');

            // 분할된 배열의 마지막 요소가 존재하면 (UUID의 마지막 부분)
            if (parts.length > 0) {
                displayOrderId = parts[parts.length - 1].slice(-12);
            }
        }

        // 화면에 값 표시
        document.getElementById("orderId").innerText = displayOrderId;
        document.getElementById("amount").innerText = `₩ ${amount.toLocaleString()}`;


        // 일반 결제 -> 서버 confirm 호출
        const requestData = {
            paymentKey: urlParams.get("paymentKey"),
            orderId: orderId,
            amount: amount
        };

        fetch('/api/deposits/confirm', {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(requestData)
        })
            .then(response => response.json())
            .then(result => {
                console.log("confirm result:", result);
                if (result.message === "충전 완료") {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('success-content').style.display = 'block';
                } else {
                    location.href = "/api/deposits/fail";
                }
            })
            .catch(error => {
                console.error("충전 중 오류:", error);
                location.href = "/api/deposits/fail";
            });

    });
</script>
</body>
</html>
